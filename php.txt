<?php 
/* comprueba que el usuario haya abierto sesión o redirige */
require_once 'sesiones.php';
require_once 'bd.php'; // Necesitamos las funciones de BD
comprobar_sesion();

$cod = $_POST['cod'];
$unidades = (int)$_POST['unidades'];
$emailUsuario = $_SESSION['usuario']['gmail']; // Obtenemos el ID para la BD

try {
    // --- 1. Lógica de Sesión (Siempre Primero y en Memoria) ---
    /* si existe el código sumamos las unidades */
    if(isset($_SESSION['carrito'][$cod])){
        $_SESSION['carrito'][$cod] += $unidades;
    }else{
        $_SESSION['carrito'][$cod] = $unidades;     
    }

    // --- 2. LÓGICA DE PERSISTENCIA (Protegida por el interruptor) ---

    // El registro principal (cabecera) SÓLO se crea si no tenemos ya el ID de la BD
    if (!isset($_SESSION['CodCarro'])) {
        
        // Ejecuta la función que inserta la CABECERA del carrito con Enviado=0
        $codCarro = crear_registro_carro($emailUsuario); 
        
        if ($codCarro === FALSE) {
            // Si la BD falla al crear el registro, lanzamos una excepción
            throw new Exception("Fallo al crear el registro principal del carrito en la BD.");
        }
        
        // ¡Guardamos el ID para que el IF no se ejecute más!
        $_SESSION['CodCarro'] = $codCarro; 
    }

    // --- 3. SINCRONIZACIÓN DE DETALLES ---
    // Ahora que SIEMPRE tenemos un $_SESSION['CodCarro'], sincronizamos los productos
    $codCarroExistente = $_SESSION['CodCarro'];
    
    // Esta función borra las líneas viejas e inserta las nuevas desde la sesión
    $resultado = sincronizar_carrito_bd($codCarroExistente, $_SESSION['carrito'], $emailUsuario);

    if ($resultado === FALSE) {
        throw new Exception("Fallo al sincronizar los productos del carrito en la BD.");
    }
    
    // Si todo va bien, redirigimos
    header("Location: carrito.php");
    return;
    
} catch (Exception $e) {
    // Capturamos cualquier error de la BD y lo manejamos
    error_log("Error de carrito en añadir_producto: " . $e->getMessage());
    // Redireccionamos a una página de error o mostramos un mensaje
    header("Location: error.php?msg=" . urlencode("Error crítico al actualizar el carrito."));
    return;
}